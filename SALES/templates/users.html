{% extends "base.html" %}

{% block title %}帳號管理 - 業務部智慧化銷售系統{% endblock %}

{% block content %}
            <h1>帳號管理</h1>

            <!-- Add User Form -->
            <div class="form-container">
                <h2>新增帳號</h2>
                <form action="{{ url_for('add_user') }}" method="POST">
                    <div class="form-group">
                        <label for="employee_id">員工ID</label>
                        <input type="text" id="employee_id" name="employee_id" required>
                    </div>
                    <div class="form-group">
                        <label for="password">密碼</label>
                        <input type="password" id="password" name="password" required>
                    </div>
                    <div class="form-group">
                        <label for="name">姓名</label>
                        <input type="text" id="name" name="name" required>
                    </div>
                    <div class="form-group">
                        <label for="role">權限</label>
                        <select id="role" name="role">
                            <option value="user">一般使用者</option>
                            <option value="administrator">管理員</option>
                            
                        </select>
                    </div>
                    <button type="submit" class="btn">新增帳號</button>
                </form>
            </div>

            <!-- Search Form -->
            <div class="search-container">
                <form action="{{ url_for('users') }}" method="GET">
                    <input type="text" name="search" placeholder="搜尋帳號..." value="{{ search_query or '' }}">
                    <button type="submit" class="btn">搜尋</button>
                </form>
            </div>

            <!-- Users Table -->
            <h2>帳號列表</h2>
            <table>
                <thead>
                    <tr>
                        
                        <th>員工ID</th>
                        <th>姓名</th>
                        <th>目前權限</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    <tr>
                        
                        <td>{{ user.employee_id }}</td>
                        <td>{{ user.name }}</td>
                        <td>
                            {% if user.role == 'system_admin' %}
                                系統管理員
                            {% elif user.role == 'administrator' %}
                                管理員
                            {% elif user.role == 'user' %}
                                一般使用者
                            {% else %}
                                {{ user.role }}
                            {% endif %}
                        </td>
                        <td class="actions">
                            {% if session['user']['role'] == 'system_admin' %}
                                {# System Admin can manage all users #}
                                <a href="{{ url_for('edit_user', user_id=user.id) }}" class="btn btn-edit">修改</a>
                                <form action="{{ url_for('delete_user', user_id=user.id) }}" method="POST" style="display:inline;">
                                    <button type="submit" class="btn btn-delete" onclick="return confirm('確定要刪除這個帳號嗎？');">刪除</button>
                                </form>
                            {% elif session['user']['role'] == 'administrator' %}
                                {# Administrator can manage general users, but not system_admin or other administrators #}
                                {% if user.role == 'user' or user.id == session['user']['id'] %}
                                    <a href="{{ url_for('edit_user', user_id=user.id) }}" class="btn btn-edit">修改</a>
                                    <form action="{{ url_for('delete_user', user_id=user.id) }}" method="POST" style="display:inline;">
                                        <button type="submit" class="btn btn-delete" onclick="return confirm('確定要刪除這個帳號嗎？');">刪除</button>
                                    </form>
                                {% endif %}
                            {% elif session['user']['role'] == 'user' %}
                                {# General user can only manage their own account #}
                                {% if user.id == session['user']['id'] %}
                                    <a href="{{ url_for('edit_user', user_id=user.id) }}" class="btn btn-edit">修改</a>
                                    <form action="{{ url_for('delete_user', user_id=user.id) }}" method="POST" style="display:inline;">
                                        <button type="submit" class="btn btn-delete" onclick="return confirm('確定要刪除這個帳號嗎？');">刪除</button>
                                    </form>
                                {% endif %}
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
{% endblock %}